        .text
        .code64
        .global __switch_threads

    __switch_threads:           // примерно так выглядит вариант переключения контекста из текущей версии ядра линукс
        pushq %rbx              // регистры (контекст) сохраняется на стек
        pushq %rbp              // только необходмые регистры общего назначения
        pushq %r12
        pushq %r13
        pushq %r14
        pushq %r15
        pushfq                  // флаговый регистр
        
        /* rdi - первый аргумент функции (**prev указатель на указатель) */
        movq %rsp, (%rdi)       // текущий указатель стека процесса (rsp) сохраняется через rdi туда, куда указал **prev
                                // () - разыменование **prev до *prev, копирование в адрес *prev значения регистра rsp

        /* rsi - второй аргумент функции (*next) */
        movq %rsi, %rsp         // указатель стека rsp теперь хранит значение адреса, переданного во втором аргументе
                                // теперь для процессора стек - это область памяти по новому адресу, где должен лежать контекст 
                                // нового процесса

        popfq                   // восстановить регистры (контекст) для процесса, на который переключаемся
        popq %r15
        popq %r14
        popq %r13
        popq %r12
        popq %rbp
        popq %rbx

        retq                    // передаем управление назад (функция retq достает адрес возврата со стека)
                                // теперь уже "нового" стека, потока, на который переключаемся